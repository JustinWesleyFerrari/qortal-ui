!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";const e=new Epml({type:"WINDOW",source:window.parent});let t,n;new Epml({type:"PROXY",source:{proxy:e,target:"visible-plugin",id:"core-plugin"}});let o,a,r,s=0,i=!1,d=!1,l=!1,p=!0,c=!1,u=0,m=!1,g=!1,w=!1;e.subscribe("logged_in",(e=>{w="true"===e}));const S=async()=>{const t=await e.request("apiCall",{url:"/admin/info"});e.request("updateNodeInfo",t)};let h,C=0;const b=()=>{t.close(),i=!0,o.close(),c=!0},T=t=>{e.request("updateBlockInfo",t)},f=async t=>{e.request("updateNodeStatus",t)},x=e=>{0==e.node||1==e.node?v():void 0!==o&&(o.close(),c=!0)},O=()=>{let o,a=window.parent.reduxStore.getState().app.nodeConfig.knownNodes[window.parent.reduxStore.getState().app.nodeConfig.node],d=a.domain+":"+a.port;o="https:"===window.parent.location.protocol?`wss://${d}/websockets/blocks`:`ws://${d}/websockets/blocks`;const c=new WebSocket(o);c.onopen=e=>{console.log("[SOCKET-BLOCKS]: Connected."),i=!1,t=c,s+=1},c.onmessage=t=>{T(JSON.parse(t.data)),w&&(async t=>{let n={names:await e.request("apiCall",{url:`/names/address/${t}`}),addressInfo:await e.request("apiCall",{url:`/addresses/${t}`})};!0!==window.parent._.isEqual(r,n)&&(e.request("setAccountInfo",n),r=n)})(window.parent.reduxStore.getState().app.selectedAddress.address)},c.onclose=()=>{console.log("[SOCKET-BLOCKS]: CLOSED"),T({}),p=!0,clearInterval(n),!1===i&&s<=52&&(s<=52?(l=!0,setTimeout(k,1e4),s+=1):l=!1)},c.onerror=e=>{console.log(`[SOCKET-BLOCKS]: ${e.type}`),p=!0,T({})},p&&e.request("apiCall",{url:"/blocks/last"}).then((e=>{T(e),p=!1}))},k=()=>{d?(d=!1,O(),n=setTimeout(k,295e3)):l?(l=!1,clearTimeout(n),O(),d=!0,n=setTimeout(k,295e3)):(t.send("non-integer ping"),n=setTimeout(k,295e3))},q=()=>{let e,t=window.parent.reduxStore.getState().app.nodeConfig.knownNodes[window.parent.reduxStore.getState().app.nodeConfig.node],n=t.domain+":"+t.port;e="https:"===window.parent.location.protocol?`wss://${n}/websockets/admin/status`:`ws://${n}/websockets/admin/status`;const r=new WebSocket(e);r.onopen=e=>{console.log("[SOCKET-NODE-STATUS]: Connected."),c=!1,o=r,u+=1},r.onmessage=e=>{f(JSON.parse(e.data))},r.onclose=()=>{console.log("[SOCKET-NODE-STATUS]: CLOSED"),f({}),clearInterval(a),!1===c&&u<=52&&(u<=52?(m=!0,setTimeout(v,1e4),u+=1):m=!1)},r.onerror=e=>{console.log(`[SOCKET-NODE-STATUS]: ${e.type}`),f({})}},v=()=>{g?(clearTimeout(a),q(),g=!1,a=setTimeout(v,295e3)):m?(m=!1,clearTimeout(a),q(),a=setTimeout(v,295e3)):(o.send("non-integer ping"),a=setTimeout(v,295e3))},N=e=>[...e.groups.map((e=>0===e.groupId?{groupId:e.groupId,url:`group/${e.groupId}`,groupName:"Qortal General Chat",sender:e.sender,senderName:e.senderName,timestamp:void 0===e.timestamp?1:e.timestamp}:{...e,url:`group/${e.groupId}`})),...e.direct.map((e=>({...e,url:`direct/${e.address}`})))];let E=0;const y=t=>{let n=`${window.parent.reduxStore.getState().app.selectedAddress.address.substr(0,10)}_chat-heads`;try{let o=localStorage.getItem(n);null===o?e.request("setLocalStorage",{key:n,dataObj:t}).then((n=>{e.request("setChatHeads",t).then((e=>{}))})):(e.request("setLocalStorage",{key:n,dataObj:t}).then((n=>{e.request("setChatHeads",t).then((e=>{}))})),E>=1?((t,n)=>{let o=JSON.parse(n);if(!0!==window.parent._.isEqual(o,t)){let n=N(o);N(t).filter((e=>!n.some((t=>e.timestamp===t.timestamp)))).forEach((t=>{t.sender!==window.parent.reduxStore.getState().app.selectedAddress.address&&void 0!==t.sender&&e.request("showNotification",t)}))}})(t,o):E+=1)}catch(e){console.error(e)}};let $,I,A=0,K=!1,B=!1,D=!1,z=!1;e.subscribe("logged_in",(async t=>{const n=()=>{let t,n=window.parent.reduxStore.getState().app.nodeConfig.knownNodes[window.parent.reduxStore.getState().app.nodeConfig.node],a=n.domain+":"+n.port;t="https:"===window.parent.location.protocol?`wss://${a}/websockets/chat/active/${window.parent.reduxStore.getState().app.selectedAddress.address}`:`ws://${a}/websockets/chat/active/${window.parent.reduxStore.getState().app.selectedAddress.address}`;const r=new WebSocket(t);r.onopen=()=>{console.log("[SOCKET]: Connected."),$=r,A+=1,z=!0},r.onmessage=e=>{y(JSON.parse(e.data))},r.onclose=()=>{console.log("[SOCKET]: CLOSED"),clearInterval(I),!1===K&&A<=52&&(A<=52?(e.request("showSnackBar","Connection to the Qortal Core was lost, is your Core running ?"),D=!0,setTimeout(o,1e4),A+=1):e.request("showSnackBar","Cannot connect to the Qortal Core, restart UI and Core!"))},r.onerror=e=>{console.log(`[SOCKET]: ${e.type}`)}},o=()=>{!0===window.parent.reduxStore.getState().app.loggedIn?B?D?(D=!1,clearTimeout(I),n(),B=!0,I=setTimeout(o,295e3)):z&&($.send("ping"),I=setTimeout(o,295e3)):(n(),B=!0,I=setTimeout(o,295e3)):B&&!K&&(K=!0,$.close(),clearTimeout(I),B=!1,z=!1)};"true"===t?((async t=>{let n={names:await e.request("apiCall",{url:`/names/address/${t}`}),addressInfo:await e.request("apiCall",{url:`/addresses/${t}`})};e.request("setAccountInfo",n)})(window.parent.reduxStore.getState().app.selectedAddress.address),o()):(B&&(K=!0,$.close(),clearTimeout(I),B=!1,z=!1),E=0)})),e.ready().then((()=>{e.subscribe("node_config",(e=>{if(0===C){let n=JSON.parse(e);h={node:n.node,knownNodes:n.knownNodes},C+=1,g=!0,d=!0,void 0!==t&&b(),void 0!==o&&b(),x(h),k(),S()}let n=JSON.parse(e),a={node:n.node,knownNodes:n.knownNodes};!0!==window.parent._.isEqual(h,a)&&(h=a,g=!0,d=!0,void 0!==t&&b(),void 0!==o&&b(),x(a),k(),S())}))})),e.imReady();let L=!1;e.ready().then((()=>{let t=[{url:"minting",domain:"core",page:"minting/index.html",title:"Minting Details",icon:"vaadin:info-circle",menus:[],parent:!1},{url:"become-minter",domain:"core",page:"become-minter/index.html",title:"Become a Minter",icon:"vaadin:info-circle",menus:[],parent:!1},{url:"sponsorship-list",domain:"core",page:"sponsorship-list/index.html",title:"Become a Minter",icon:"vaadin:info-circle",menus:[],parent:!1},{url:"wallet",domain:"core",page:"wallet/index.html",title:"Wallet",icon:"vaadin:wallet",menus:[],parent:!1},{url:"trade-portal",domain:"core",page:"trade-portal/index.html",title:"Trade Portal",icon:"vaadin:bullets",menus:[],parent:!1},{url:"trade-bot-portal",domain:"core",page:"trade-bot/index.html",title:"Auto Buy",icon:"vaadin:calc-book",menus:[],parent:!1},{url:"reward-share",domain:"core",page:"reward-share/index.html",title:"Reward Share",icon:"vaadin:share-square",menus:[],parent:!1},{url:"name-registration",domain:"core",page:"name-registration/index.html",title:"Name Registration",icon:"vaadin:user-check",menus:[],parent:!1},{url:"websites",domain:"core",page:"qdn/index.html",title:"Websites",icon:"vaadin:desktop",menus:[],parent:!1},{url:"data-management",domain:"core",page:"qdn/data-management/index.html",title:"Data Management",icon:"vaadin:database",menus:[],parent:!1},{url:"q-chat",domain:"core",page:"messaging/q-chat/index.html",title:"Q-Chat",icon:"vaadin:chat",menus:[],parent:!1},{url:"group-management",domain:"core",page:"group-management/index.html",title:"Group Management",icon:"vaadin:group",menus:[],parent:!1},{url:"puzzles",domain:"core",page:"puzzles/index.html",title:"Puzzles",icon:"vaadin:puzzle-piece",menus:[],parent:!1}];const n=t=>{e.request("registerUrl",t)},o=window.parent.reduxStore.getState().app.nodeConfig.knownNodes[window.parent.reduxStore.getState().app.nodeConfig.node];e.subscribe("config",(e=>{if(JSON.parse(e),!L&&o.enableManagement){L=!0;let e={url:"node-management",domain:"core",page:"node-management/index.html",title:"Node Management",icon:"vaadin:cloud",menus:[],parent:!1},o=[...t,e];n(o)}else n(t)}))}))}));
